<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Pre-Test</title>
  <meta name="description" content="VR Pre-Test Battery"/>
  <link rel="icon" href="data:,">

  <!-- jsPsych CSS -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">

  <!-- SurveyJS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/survey-core@1.11.7/defaultV2.min.css">

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    header h1 { font-size: 20px; margin: 0; }
    #jspsych-target { min-height: 60vh; }
    .precheck { font-size: 12px; color:#666; margin-bottom:12px; }
    .warn { color:#c1272d; font-weight: 600; }
    .success { color:#2e7d32; font-weight: 600; }
    
    /* Loading indicator */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 20px;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2196F3;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      font-size: 16px;
      color: #666;
    }
    
    /* Ensure survey is visible */
    #surveyContainer {
      display: block !important;
      width: 100% !important;
      min-height: 400px !important;
      background: white !important;
    }
    .sd-root-modern {
      display: block !important;
      visibility: visible !important;
    }
    
    details { 
      position: fixed; 
      bottom: 10px; 
      right: 10px; 
      background: white; 
      padding: 10px; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      max-width: 300px; 
      z-index: 1000; 
    }
    details summary { cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing experiment...</div>
    <div id="loading-status" style="font-size: 12px; color: #999;"></div>
  </div>

  <div class="wrap">
    <header>
      <h1>VR Pre-Test</h1>
      <div class="precheck" id="lib-check">Checking libraries…</div>
    </header>

    <div id="jspsych-target"></div>

    <details>
      <summary>Help / Requirements</summary>
      <ul>
        <li>Assets required:
          <ul>
            <li><code>sounds/*.mp3</code> for phoneme/foley</li>
            <li><code>img/*.jpg|jpeg|svg</code> for picture/visual tasks</li>
            <li><code>pron/*.mp3</code> for model pronunciations</li>
          </ul>
        </li>
        <li>All libraries loaded from CDN</li>
        <li>Open browser console (F12) for detailed logs</li>
      </ul>
    </details>
  </div>

  <!-- Load libraries in order -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3"></script>

  <!-- SurveyJS -->
  <script src="https://unpkg.com/knockout@3.5.1/build/output/knockout-latest.js"></script>
  <script src="https://unpkg.com/survey-core@1.11.7/survey.core.min.js"></script>
  <script src="https://unpkg.com/survey-knockout-ui@1.11.7"></script>

  <!-- Embedded jsPsych ↔ SurveyJS bridge (IMPROVED VERSION) -->
  <script>
    (function() {
      'use strict';

      const SurveyPlugin = (function() {
        const info = {
          name: 'survey',
          parameters: {
            survey_json: { type: 'complex', default: {} },
            survey_function: { type: 'function', default: () => ({}) }
          }
        };

        class Plugin {
          constructor(jsPsych) {
            this.jsPsych = jsPsych;
          }

          trial(display_element, trial) {
            console.log('[jsPsychSurvey] Starting survey trial');

            let surveyJson = trial.survey_json;
            if (!surveyJson || Object.keys(surveyJson).length === 0) {
              if (typeof trial.survey_function === 'function') {
                surveyJson = trial.survey_function();
              }
            }

            console.log('[jsPsychSurvey] Rendering survey…');
            display_element.innerHTML =
              '<div id="surveyContainer" style="display:block;width:100%;min-height:400px;"></div>';
            
            const container = display_element.querySelector('#surveyContainer');
            if (!container) {
              console.error('[jsPsychSurvey] surveyContainer not found');
              this.jsPsych.finishTrial({ error: 'Survey container missing' });
              return;
            }

            // Normalize the SurveyJS namespace (handles Module.default exports)
            const SurveyNamespace =
              (window.Survey && window.Survey.default) ? window.Survey.default : window.Survey;
            
            if (!SurveyNamespace) {
              console.error('[jsPsychSurvey] SurveyJS namespace unavailable');
              this.jsPsych.finishTrial({ error: 'SurveyJS unavailable' });
              return;
            }

            // Make sure window.Survey points at the usable namespace for any other code
            window.Survey = SurveyNamespace;
            console.log('[jsPsychSurvey] Survey namespace normalized:', typeof SurveyNamespace.Model);

            const surveyInstance = new SurveyNamespace.Model(surveyJson);
            
            surveyInstance.onComplete.add((sender) => {
              console.log('[jsPsychSurvey] Survey completed');
              const trial_data = {
                response: sender.data,
                rt: null,
                question_order:
                  (surveyJson.pages?.[0]?.elements || []).map(e => e.name)
              };
              display_element.innerHTML = '';
              this.jsPsych.finishTrial(trial_data);
            });

            try {
              // For Knockout-based SurveyJS, we need to use ko.applyBindings
              if (window.ko && typeof window.ko.applyBindings === 'function') {
                console.log('[jsPsychSurvey] Rendering via Knockout bindings');
                
                // Create the survey HTML structure that Knockout expects
                container.innerHTML = '<div data-bind="survey: survey"></div>';
                
                // Apply Knockout bindings
                window.ko.applyBindings({ survey: surveyInstance }, container);
                
              } else if (typeof surveyInstance.render === 'function') {
                console.log('[jsPsychSurvey] Rendering via surveyInstance.render (fallback)');
                surveyInstance.render(container);
              } else {
                throw new Error('Neither Knockout nor Survey render API available');
              }
              
              console.log('[jsPsychSurvey] Survey render initiated');
              
              // Wait a moment and check if it rendered
              setTimeout(() => {
                const childCount = container.children.length;
                const htmlLength = container.innerHTML.length;
                console.log('[jsPsychSurvey] Container check after 100ms:',
                  'children=' + childCount,
                  'innerHTML length=' + htmlLength);
                
                if (childCount === 0 || htmlLength < 100) {
                  console.error('[jsPsychSurvey] Survey failed to render properly');
                  throw new Error('Survey rendered but produced no content');
                } else {
                  console.log('[jsPsychSurvey] ✓ Survey rendered successfully');
                }
              }, 100);

            } catch (error) {
              console.error('[jsPsychSurvey] Error rendering survey:', error);
              display_element.innerHTML = 
                '<div style="padding:20px;color:#c00;text-align:center;">' +
                '<h3>Survey Failed to Load</h3>' +
                '<p>Error: ' + (error?.message || String(error)) + '</p>' +
                '<p style="font-size:12px;">Check browser console for details.</p>' +
                '</div>';
              
              setTimeout(() => {
                this.jsPsych.finishTrial({ error: error?.message || String(error) });
              }, 3000);
            }
          }
        }

        Plugin.info = info;
        return Plugin;
      })();

      if (typeof window !== 'undefined') {
        window.jsPsychSurvey = SurveyPlugin;
        console.log('[jsPsychSurvey] Plugin registered');
      }
    })();
  </script>

  <!-- Your pretest logic -->
  <script src="pretest.js"></script>

  <!-- Enhanced initialization wrapper -->
  <script>
    (function() {
      const updateLoadingStatus = (message) => {
        const statusEl = document.getElementById('loading-status');
        if (statusEl) statusEl.textContent = message;
        console.log('[Init]', message);
      };

      const hideLoading = () => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.3s';
          setTimeout(() => overlay.remove(), 300);
        }
      };

      const showError = (message) => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.innerHTML = `
            <div style="text-align:center; padding:40px;">
              <div style="font-size:48px;color:#c1272d;">⚠️</div>
              <h2 style="color:#c1272d;">Initialization Error</h2>
              <p style="max-width:500px;">${message}</p>
              <p style="font-size:12px;color:#666;margin-top:10px;">Check browser console (F12) for details</p>
              <button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;">
                Reload Page
              </button>
            </div>`;
        }
      };

      window.addEventListener('load', () => {
        updateLoadingStatus('Checking libraries...');

        // Check all required libraries
        const el = document.getElementById('lib-check');
        const checks = [
          ['initJsPsych', typeof window.initJsPsych === 'function'],
          ['Knockout (ko)', typeof window.ko === 'object' && typeof window.ko.applyBindings === 'function'],
          ['Survey', typeof (window.Survey?.default || window.Survey) === 'object'],
          ['jsPsychSurvey', typeof window.jsPsychSurvey === 'function'],
          ['HtmlButtonResponse', typeof window.jsPsychHtmlButtonResponse === 'function'],
          ['HtmlKeyboardResponse', typeof window.jsPsychHtmlKeyboardResponse === 'function'],
          ['SurveyText', typeof window.jsPsychSurveyText === 'function'],
          ['InitializeMicrophone', typeof window.jsPsychInitializeMicrophone === 'function'],
          ['HtmlAudioResponse', typeof window.jsPsychHtmlAudioResponse === 'function']
        ];

        const missing = checks.filter(([_, v]) => !v).map(([k]) => k);
        
        if (missing.length) {
          const msg = 'Missing libraries: ' + missing.join(', ');
          el.innerHTML = '<span class="warn">' + msg + '</span>';
          showError(msg + '<br><br>Please check your internet connection and reload.');
          return;
        }

        el.innerHTML = '<span class="success">✓ All libraries loaded</span>';
        updateLoadingStatus('Starting experiment...');

        // Wait for pretest.js to initialize
        setTimeout(() => {
          console.log('[Init] Checking for jsPsych initialization...');
          
          // Monitor for jsPsych to start
          const checkInterval = setInterval(() => {
            if (window.jsPsych) {
              console.log('[Init] jsPsych detected, hiding loading overlay');
              clearInterval(checkInterval);
              hideLoading();
            }
          }, 100);
          
          // Timeout after 10 seconds
          setTimeout(() => {
            clearInterval(checkInterval);
            if (!window.jsPsych) {
              console.error('[Init] jsPsych failed to initialize within 10 seconds');
              showError('Experiment failed to start.<br><br>Possible causes:<br>• Asset validation taking too long<br>• JavaScript error in pretest.js<br><br>Check console for details.');
            }
          }, 10000);
        }, 500);
      });
    })();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Pre-Test</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#fafafa; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    header h1 { font-size: 20px; margin: 0; }
    #jspsych-target { min-height: 60vh; }
    .precheck { font-size: 12px; color:#666; margin-bottom:12px; }
    .warn { color:#c1272d; font-weight: 600; }
    .success { color:#2e7d32; font-weight: 600; }

    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95);
      display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 20px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2196F3;
      border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { font-size: 16px; color: #666; }

    details { position: fixed; bottom: 10px; right: 10px; background: white;
      padding: 10px; border: 1px solid #ccc; border-radius: 6px; max-width: 300px; z-index: 1000; }
    details summary { cursor: pointer; font-weight: 600; }

    /* Nice defaults for jsPsych layout */
    .jspsych-content { position: relative !important; text-align: center !important;
      max-width: 840px !important; margin: 0 auto !important; padding: 20px !important; }

    /* Spatial span grid */
    .corsi-grid { width: 420px; height: 420px; margin: 0 auto;
      display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 10px; }
    .corsi-cell { background:#e0e0e0; border-radius: 10px; box-shadow: inset 0 0 0 2px #bdbdbd; cursor: pointer; transition: transform .08s ease; }
    .corsi-cell:active { transform: scale(.98); }
    .corsi-cell.playback { cursor: default; }
    .corsi-cell.lit { background:#90caf9; box-shadow: 0 0 0 3px #1e88e5 inset; }
    .msg { color:#666; font-size: 14px; margin-top:10px; }
    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px;
      background:#212121; color:#fff; padding:10px 14px; border-radius:10px; font-size:13px; z-index: 2000; opacity:.95; }
  </style>
</head>
<body>
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing experiment...</div>
    <div id="loading-status" style="font-size: 12px; color: #999;"></div>
  </div>

  <div class="wrap">
    <header>
      <h1>VR Pre-Test</h1>
      <div class="precheck" id="lib-check">Checking libraries…</div>
    </header>
    <div id="jspsych-target"></div>
    <details>
      <summary>Help / Requirements</summary>
      <ul>
        <li>Assets required:
          <ul>
            <li><code>sounds/*.mp3</code> for phoneme/foley</li>
            <li><code>img/*.jpg|jpeg|svg</code> for picture/visual tasks</li>
          </ul>
        </li>
        <li>All libraries loaded from CDN</li>
        <li>Open browser console (F12) for detailed logs</li>
      </ul>
    </details>
  </div>

  <!-- jsPsych Core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>

  <!-- jsPsych Plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3"></script>

  <!-- Your pretest logic -->
  <script src="pretest.js"></script>

  <!-- Initialization wrapper -->
  <script>
    (function() {
      const updateLoadingStatus = (msg) => {
        const el = document.getElementById('loading-status');
        if (el) el.textContent = msg;
        console.log('[Init]', msg);
      };

      const hideLoading = () => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.3s';
          setTimeout(() => overlay.remove(), 300);
        }
      };

      const showError = (msg) => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.innerHTML = `
            <div style="text-align:center; padding:40px;">
              <div style="font-size:48px;color:#c1272d;">⚠️</div>
              <h2 style="color:#c1272d;">Initialization Error</h2>
              <p style="max-width:500px;">${msg}</p>
              <p style="font-size:12px;color:#666;margin-top:10px;">Check browser console (F12) for details</p>
              <button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;">
                Reload Page
              </button>
            </div>`;
        }
      };

      window.addEventListener('load', () => {
        updateLoadingStatus('Checking libraries...');

        const el = document.getElementById('lib-check');
        const checks = [
          ['initJsPsych', typeof window.initJsPsych === 'function'],
          ['HtmlButtonResponse', typeof window.jsPsychHtmlButtonResponse === 'function'],
          ['HtmlKeyboardResponse', typeof window.jsPsychHtmlKeyboardResponse === 'function'],
          ['SurveyText', typeof window.jsPsychSurveyText === 'function'],
          ['SurveyLikert', typeof window.jsPsychSurveyLikert === 'function'],
          ['InitializeMicrophone', typeof window.jsPsychInitializeMicrophone === 'function'],
          ['HtmlAudioResponse', typeof window.jsPsychHtmlAudioResponse === 'function']
        ];

        const missing = checks.filter(([_, v]) => !v).map(([k]) => k);
        if (missing.length) {
          const msg = 'Missing libraries: ' + missing.join(', ');
          el.innerHTML = '<span class="warn">' + msg + '</span>';
          showError(msg + '<br><br>Please check your internet connection and reload.');
          return;
        }

        el.innerHTML = '<span class="success">✓ All libraries loaded</span>';
        updateLoadingStatus('Starting experiment...');

        // Poll until pretest.js exposes window.jsPsych, then hide the overlay
        setTimeout(() => {
          const checkInterval = setInterval(() => {
            if (window.jsPsych) {
              console.log('[Init] jsPsych detected, hiding loading overlay');
              clearInterval(checkInterval);
              hideLoading();
            }
          }, 100);

          setTimeout(() => {
            clearInterval(checkInterval);
            if (!window.jsPsych) {
              console.error('[Init] jsPsych failed to initialize');
              showError('Experiment failed to start.<br><br>Check console for details.');
            }
          }, 10000);
        }, 500);
      });
    })();
  </script>
</body>
</html>

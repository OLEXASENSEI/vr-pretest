<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Pre-Test</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">
  <link rel="stylesheet" href="https://unpkg.com/survey-knockout@1.9.112/defaultV2.min.css">
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    header h1 { font-size: 20px; margin: 0; }
    #jspsych-target { min-height: 60vh; }
    .precheck { font-size: 12px; color:#666; margin-bottom:12px; }
    .warn { color:#c1272d; font-weight: 600; }
    .success { color:#2e7d32; font-weight: 600; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 20px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { font-size: 16px; color: #666; }
    #surveyContainer { display: block !important; width: 100% !important; min-height: 400px !important; }
    .sv_main { display: block !important; visibility: visible !important; }
    details { position: fixed; bottom: 10px; right: 10px; background: white; padding: 10px; border: 1px solid #ccc; border-radius: 6px; max-width: 300px; z-index: 1000; }
    details summary { cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing...</div>
    <div id="loading-status" style="font-size: 12px; color: #999;"></div>
  </div>
  <div class="wrap">
    <header>
      <h1>VR Pre-Test</h1>
      <div class="precheck" id="lib-check">Checking...</div>
    </header>
    <div id="jspsych-target"></div>
    <details>
      <summary>Help</summary>
      <ul>
        <li>Assets: sounds/*.mp3, img/*.jpg|jpeg|svg</li>
        <li>Press F12 for console</li>
      </ul>
    </details>
  </div>

  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3"></script>
  <script src="https://unpkg.com/knockout@3.5.1/build/output/knockout-latest.js"></script>
  <script src="https://unpkg.com/survey-knockout@1.9.112/survey.ko.min.js"></script>

  <!-- Bridge Plugin -->
  <script>
    (function() {
      'use strict';
      const SurveyPlugin = (function() {
        const info = {
          name: 'survey',
          parameters: {
            survey_json: { type: 'complex', default: {} },
            survey_function: { type: 'function', default: () => ({}) }
          }
        };
        class Plugin {
          constructor(jsPsych) { this.jsPsych = jsPsych; }
          trial(display_element, trial) {
            console.log('[Survey] Starting trial');
            let surveyJson = trial.survey_json;
            if (!surveyJson || Object.keys(surveyJson).length === 0) {
              if (typeof trial.survey_function === 'function') {
                surveyJson = trial.survey_function();
              }
            }
            
            const containerId = 'survey-' + Date.now();
            display_element.innerHTML = '<div id="' + containerId + '"></div>';
            
            setTimeout(() => {
              const container = document.getElementById(containerId);
              if (!container) {
                console.error('[Survey] Container not found');
                this.jsPsych.finishTrial({ error: 'No container' });
                return;
              }
              
              try {
                console.log('[Survey] Creating with Survey.Survey + element');
                const survey = new window.Survey.Survey(surveyJson, container);
                
                survey.onComplete.add((sender) => {
                  console.log('[Survey] Complete');
                  const trial_data = {
                    response: sender.data,
                    rt: null,
                    question_order: (surveyJson.pages?.[0]?.elements || []).map(e => e.name)
                  };
                  display_element.innerHTML = '';
                  this.jsPsych.finishTrial(trial_data);
                });
                
                console.log('[Survey] Created successfully');
                setTimeout(() => {
                  console.log('[Survey] Check:', container.innerHTML.length, 'chars');
                }, 200);
                
              } catch (error) {
                console.error('[Survey] Error:', error);
                display_element.innerHTML = '<div style="padding:20px;color:#c00;text-align:center;"><h3>Survey Error</h3><p>' + error.message + '</p></div>';
                setTimeout(() => this.jsPsych.finishTrial({ error: error.message }), 2000);
              }
            }, 10);
          }
        }
        Plugin.info = info;
        return Plugin;
      })();
      if (typeof window !== 'undefined') {
        window.jsPsychSurvey = SurveyPlugin;
        console.log('[Survey] Plugin registered');
      }
    })();
  </script>

  <script src="pretest.js"></script>

  <script>
    (function() {
      const updateStatus = (msg) => {
        const el = document.getElementById('loading-status');
        if (el) el.textContent = msg;
        console.log('[Init]', msg);
      };
      const hideLoading = () => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.3s';
          setTimeout(() => overlay.remove(), 300);
        }
      };
      window.addEventListener('load', () => {
        updateStatus('Checking...');
        const el = document.getElementById('lib-check');
        const checks = [
          ['jsPsych', typeof window.initJsPsych === 'function'],
          ['ko', typeof window.ko === 'object'],
          ['Survey', typeof window.Survey?.Survey === 'function'],
          ['jsPsychSurvey', typeof window.jsPsychSurvey === 'function']
        ];
        const missing = checks.filter(([_, v]) => !v).map(([k]) => k);
        if (missing.length) {
          el.innerHTML = '<span class="warn">Missing: ' + missing.join(', ') + '</span>';
          return;
        }
        el.innerHTML = '<span class="success">âœ“ Ready</span>';
        updateStatus('Starting...');
        setTimeout(() => {
          const check = setInterval(() => {
            if (window.jsPsych) {
              clearInterval(check);
              hideLoading();
            }
          }, 100);
          setTimeout(() => clearInterval(check), 10000);
        }, 500);
      });
    })();
  </script>
</body>
</html>
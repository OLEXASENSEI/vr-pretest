<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VR Pre-Test</title>
  <meta name="description" content="VR Pre-Test Battery"/>
  <link rel="icon" href="data:,">

  <!-- jsPsych CSS -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">

  <!-- SurveyJS CSS - Updated for proper rendering -->
  <link rel="stylesheet" href="https://unpkg.com/survey-core@1.11.7/defaultV2.min.css">
  <style>
    /* Ensure survey is visible */
    #surveyContainer { 
      display: block !important; 
      width: 100% !important;
      min-height: 400px !important;
      background: white !important;
    }
    .sd-root-modern {
      display: block !important;
      visibility: visible !important;
    }
  </style>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    header h1 { font-size: 20px; margin: 0; }
    #jspsych-target { min-height: 60vh; }
    .precheck { font-size: 12px; color:#666; margin-bottom:12px; }
    .warn { color:#c1272d; font-weight: 600; }
    details { position: fixed; bottom: 10px; right: 10px; background: white; padding: 10px; border: 1px solid #ccc; border-radius: 6px; max-width: 300px; z-index: 1000; }
    details summary { cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>VR Pre-Test</h1>
      <div class="precheck" id="lib-check">Loading libraries…</div>
    </header>

    <div id="jspsych-target"></div>

    <details>
      <summary>Help / Requirements</summary>
      <ul>
        <li>Make sure your assets exist at the paths used in <code>pretest.js</code>:
          <ul>
            <li><code>sounds/*.mp3</code> for phoneme/foley</li>
            <li><code>img/*.jpg|jpeg|svg</code> for picture/visual tasks</li>
            <li><code>pron/*.mp3</code> if you use model pronunciations</li>
          </ul>
        </li>
        <li>All libraries are loaded from CDN</li>
        <li>Bridge plugin is embedded in this page</li>
      </ul>
    </details>
  </div>

  <!-- Load everything in correct order WITHOUT defer -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-initialize-microphone@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-audio-response@1.0.3"></script>
  
  <!-- SurveyJS -->
  <script src="https://unpkg.com/survey-core@1.11.7/survey.core.min.js"></script>
  <script src="https://unpkg.com/survey-knockout-ui@1.11.7"></script>

  <!-- Embedded jsPsych ↔ SurveyJS bridge (jsPsychSurvey) -->
  <script>
    (function() {
      'use strict';
      
      var jsPsychSurvey = (function() {
        const info = {
          name: 'survey',
          parameters: {
            survey_json: {
              type: 'complex',
              default: {}
            },
            survey_function: {
              type: 'function',
              default: function() { return {}; }
            }
          }
        };

        class SurveyPlugin {
          constructor(jsPsych) {
            this.jsPsych = jsPsych;
          }

          trial(display_element, trial) {
            console.log('[jsPsychSurvey] trial() called');
            console.log('[jsPsychSurvey] survey_json:', trial.survey_json);
            
            if (!window.Survey) {
              console.error('SurveyJS library not loaded');
              this.jsPsych.finishTrial({ error: 'SurveyJS not loaded' });
              return;
            }

            try {
              // Prioritize survey_json, fallback to survey_function
              let surveyJson = trial.survey_json;
              if (!surveyJson || Object.keys(surveyJson).length === 0) {
                if (typeof trial.survey_function === 'function') {
                  surveyJson = trial.survey_function();
                }
              }
              
              console.log('[jsPsychSurvey] Creating survey model...');
              const survey = new Survey.Model(surveyJson);
              
              survey.onComplete.add((sender) => {
                console.log('[jsPsychSurvey] Survey completed');
                const trial_data = {
                  response: sender.data,
                  rt: null,
                  question_order: surveyJson.pages?.[0]?.elements?.map(e => e.name) || []
                };
                display_element.innerHTML = '';
                this.jsPsych.finishTrial(trial_data);
              });

              console.log('[jsPsychSurvey] Rendering survey...');
              display_element.innerHTML = '<div id="surveyContainer" style="display:block;width:100%;min-height:400px;"></div>';
              
              // Try different rendering methods
              if (typeof Survey.Survey !== 'undefined') {
                console.log('[jsPsychSurvey] Using Survey.Survey constructor');
                window.currentSurvey = new Survey.Survey(surveyJson, 'surveyContainer');
              } else if (survey.render) {
                console.log('[jsPsychSurvey] Using survey.render()');
                survey.render('surveyContainer');
              } else {
                console.error('[jsPsychSurvey] No rendering method available!');
              }
              
              console.log('[jsPsychSurvey] Survey rendered successfully');
              
              // Debug: Check if survey has visible content
              setTimeout(() => {
                const container = document.getElementById('surveyContainer');
                console.log('[jsPsychSurvey] Container children:', container?.children.length);
                console.log('[jsPsychSurvey] Container innerHTML length:', container?.innerHTML.length);
              }, 100);
            } catch (error) {
              console.error('[jsPsychSurvey] Error in trial():', error);
              this.jsPsych.finishTrial({ error: error.message });
            }
          }
        }

        SurveyPlugin.info = info;
        return SurveyPlugin;
      })();

      if (typeof window !== 'undefined') {
        window.jsPsychSurvey = jsPsychSurvey;
      }
    })();
  </script>

  <!-- Your pretest logic -->
  <script src="pretest.js?v=2028"></script>

  <!-- Runtime check -->
  <script>
    window.addEventListener('load', () => {
      const el = document.getElementById('lib-check');
      try {
        const checks = [
          ['initJsPsych', typeof window.initJsPsych === 'function'],
          ['Survey', typeof window.Survey === 'object'],
          ['jsPsychSurvey', typeof window.jsPsychSurvey === 'function'],
          ['jsPsychHtmlButtonResponse', typeof window.jsPsychHtmlButtonResponse === 'function']
        ];
        const missing = checks.filter(([_, v]) => !v).map(([k]) => k);
        if (missing.length) {
          el.innerHTML = 'Missing: <span class="warn">' + missing.join(', ') + '</span>';
        } else {
          el.textContent = '✓ All components loaded';
          el.style.color = '#2e7d32';
        }
      } catch (e) {
        el.textContent = 'Check failed: ' + e.message;
        el.className = 'warn';
      }
    });
  </script>
</body>
</html>